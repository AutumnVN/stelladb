---
// @ts-nocheck
import Layout from '../layouts/Layout.astro';

import Card from '../components/Card.astro';

const DATA_URL = 'https://raw.githubusercontent.com/AutumnVN/StellaSoraData/refs/heads/main/disc.json';

const data = await fetch(DATA_URL).then((res) => res.json());

const emoji = {
    Aqua: 'ğŸ’§',
    Ignis: 'ğŸ”¥',
    Terra: 'â›°ï¸',
    Ventus: 'ğŸŒªï¸',
    Lux: 'â˜€ï¸',
    Umbra: 'ğŸŒ™',
    None: 'â¬œ',
};
---

<Layout title="Disc | stelladb">
    <div class="search-wrap">
        <label for="search" class="visually-hidden">Search discs</label>
        <input id="search" type="search" placeholder="Search discs by id, name, element, or tag... holyshit finally a search bar ğŸ˜­" />
    </div>
    <div class="grid">
        {
            Object.entries(data).map(([id, disc]) => (
                <div class="card-item" data-id={id} data-name={disc.name} data-element={disc.element} data-tag={disc.tag.join(' ')}>
                    <Card
                        href={`/disc/${id}`}
                        name={disc.name}
                        desc={`${disc.star}â­ ${disc.element}${emoji[disc.element]}`}
                        desc2={disc.tag.join(', ')}
                        star={disc.star}
                        image={`https://chino.is-a.dev/cdn-cgi/image/format=avif/https://raw.githubusercontent.com/AutumnVN/ssassets/refs/heads/main/export/Assets/assetbundles/icon/outfit/outfit_${id.replace(/^.{2}/, '')}.png`}
                    />
                </div>
            ))
        }
    </div>
    <div id="no-results" hidden>No discs found.</div>
</Layout>

<style>
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }

    .search-wrap {
        display: flex;
    }

    #search {
        flex: 1 1 auto;
        padding: 0.75rem;
        border-radius: 6px;
        border: var(--text) 3px solid;
        font-size: 1.25rem;
        background: var(--bg1);
        accent-color: var(--accent);
        color: var(--text);
    }

    #search:focus {
        outline: none;
        border: var(--accent) 3px solid;
    }

    #search::-webkit-search-cancel-button {
        filter: invert(100%) sepia(100%) saturate(500%) hue-rotate(90deg);
        padding-left: 0.3rem;
    }

    .visually-hidden {
        position: absolute !important;
        height: 1px;
        width: 1px;
        overflow: hidden;
        clip: rect(1px, 1px, 1px, 1px);
        white-space: nowrap;
        border: 0;
        padding: 0;
        margin: -1px;
    }

    #no-results {
        margin-top: 2rem;
        font-size: 2rem;
        text-align: center;
        color: var(--text);
    }
</style>

<script>
    // @ts-nocheck
    const input = document.querySelector('#search');
    const grid = document.querySelector('.grid');
    const noResults = document.querySelector('#no-results');

    const items = Array.from(grid.querySelectorAll('.card-item'));

    function normalize(s) {
        return (s || '').toString().toLowerCase();
    }

    function matches(item, q) {
        if (!q) return true;
        const id = normalize(item.dataset.id);
        const name = normalize(item.dataset.name);
        const element = normalize(item.dataset.element);
        const tag = normalize(item.dataset.tag);
        return id.includes(q) || name.includes(q) || element.includes(q) || tag.includes(q);
    }

    let timeout = null;
    function onInput() {
        const q = normalize(input.value.trim());
        if (timeout) clearTimeout(timeout);
        timeout = setTimeout(() => {
            let anyMatched = false;
            items.forEach((item) => {
                const matched = matches(item, q);
                item.style.display = matched ? '' : 'none';
                if (matched) anyMatched = true;
            });
            noResults.hidden = anyMatched;
        }, 150);
    }

    input.addEventListener('input', onInput);
</script>
