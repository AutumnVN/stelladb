---
// @ts-nocheck
import Layout from '../layouts/Layout.astro';

const DATA_URL = 'https://raw.githubusercontent.com/AutumnVN/StellaSoraData/refs/heads/main/gacha.json';
const TREKKER_URL = 'https://raw.githubusercontent.com/AutumnVN/StellaSoraData/refs/heads/main/character.json';
const DISC_URL = 'https://raw.githubusercontent.com/AutumnVN/StellaSoraData/refs/heads/main/disc.json';

const data = await fetch(DATA_URL).then((res) => res.json());
const trekkerData = await fetch(TREKKER_URL).then((res) => res.json());
const discData = await fetch(DISC_URL).then((res) => res.json());

const formatShortTime = (time: string) =>
    new Date(time).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });

const normalizeRarity = (value) => {
    if (typeof value === 'number') return value;
    if (typeof value === 'string') {
        const map = { SSR: 5, SR: 4, R: 3 };
        return map[value] ?? 0;
    }
    return 0;
};

const rarityClass = (entry) => {
    const rarity = normalizeRarity(entry.star ?? entry.rarity ?? entry.rank ?? 0);
    return rarity ? `mini-${rarity}` : '';
};

const attachDetails = (entry) => {
    const isTrekker = entry.id < 10000;
    const source = isTrekker ? trekkerData : discData;
    const details = source?.[String(entry.id)] || {};

    return {
        ...entry,
        element: entry.element ?? details.element ?? 'None',
        star: normalizeRarity(entry.star ?? details.star ?? details.rarity ?? details.rank),
        rarity: normalizeRarity(entry.rarity ?? details.rarity ?? details.rank ?? details.star),
    };
};

const now = new Date();
const banners = Object.entries(data)
    .map(([id, banner]) => {
        const start = new Date(banner.startTime);
        const end = new Date(banner.endTime);

        let status = 'ONGOING';
        if (now < start) status = 'UPCOMING';
        if (now > end) status = 'ENDED';

        return {
            ...banner,
            id,
            status,
            startLabel: formatShortTime(banner.startTime),
            endLabel: formatShortTime(banner.endTime),
            rateUp5Star: banner.rateUp5Star.map(attachDetails),
            rateUp4Star: banner.rateUp4Star.map(attachDetails),
        };
    })
    .sort((a, b) => new Date(b.startTime).getTime() - new Date(a.startTime).getTime());

const sections = [
    { title: 'ONGOING', filter: (banner) => banner.status === 'ONGOING' || banner.status === 'UPCOMING' },
    { title: 'ENDED', filter: (banner) => banner.status === 'ENDED' },
];
---

<Layout title="Banner | stelladb">
    {sections.map((section) => {
        const list = banners.filter(section.filter);
        if (!list.length) return null;

        return (
            <section class="banner-section">
                <div class="section-title">{section.title}</div>
                <div class="banner-list">
                    {list.map((banner) => (
                        <article class={`banner-card status-${banner.status.toLowerCase()}`}>
                            <div class="card-top">
                                <img
                                    src={`https://chino.is-a.dev/cdn-cgi/image/format=avif/https://raw.githubusercontent.com/AutumnVN/ssassets/refs/heads/main/export/Assets/assetbundles_en/icon/gacha/tab_gacha_${banner.id}.png`}
                                    alt={banner.name}
                                    title={banner.name}
                                    width="192"
                                    height="96"
                                    loading="lazy"
                                />
                                <div class="title-block">
                                    <div class="title-row">
                    <h2>{banner.name}</h2>
                                        <span class={`status-pill status-${banner.status.toLowerCase()}`}>{banner.status}</span>
                                    </div>
                                    <p class="time-strip">
                                        <span
                                            class="time-summary"
                                            data-start={banner.startTime}
                                            data-end={banner.endTime}
                                            data-start-label={banner.startLabel}
                                            data-end-label={banner.endLabel}
                                        />
                                    </p>
                                </div>
                            </div>

                            <div class="banner-grid">
                                <div class="grid-item">
                                    <p class="meta-label">Rate-up 5★</p>
                                    <p class="meta-value">
                                        {banner.rateUp5Star.map((entry, i) => (
                                            <>
                                                {i > 0 ? ', ' : ''}
                                                <span class="rateup-chip">
                                                    <span class={`mini-card ${rarityClass(entry)}`}>
                                                        <span class="mini-icon" style={`background-image: url(/${entry.element || 'None'}.png);`} />
                                                    </span>
                                                    <a href={`/${entry.id < 10000 ? 'trekker' : 'disc'}/${entry.id}`}>{entry.name}</a>
                                                </span>
                                            </>
                                        ))}
                                    </p>
                                </div>
                                <div class="grid-item">
                                    <p class="meta-label">Rate-up 4★</p>
                                    <p class="meta-value">
                                        {banner.rateUp4Star.map((entry, i) => (
                                            <>
                                                {i > 0 ? ', ' : ''}
                                                <span class="rateup-chip">
                                                    <span class={`mini-card ${rarityClass(entry)}`}>
                                                        <span class="mini-icon" style={`background-image: url(/${entry.element || 'None'}.png);`} />
                                                    </span>
                                                    <a href={`/${entry.id < 10000 ? 'trekker' : 'disc'}/${entry.id}`}>{entry.name}</a>
                                                </span>
                                            </>
                                        ))}
                                    </p>
                                </div>
                            </div>
                        </article>
                    ))}
                </div>
            </section>
                    );
    })}
</Layout>

<script>
    // @ts-nocheck
    const dateOptions = { month: 'short', day: 'numeric' };

    updateTimeSummaries();
    setInterval(updateTimeSummaries, 1000);

    function formatCompactRelative(diff) {
        const abs = Math.abs(diff);
        const seconds = Math.round(abs / 1000);
        const minutes = Math.round(abs / (60 * 1000));
        const hours = Math.round(abs / (60 * 60 * 1000));
        const days = Math.round(abs / (24 * 60 * 60 * 1000));

        if (seconds < 60) return `${seconds}s`;
        if (minutes < 60) return `${minutes}m`;
        if (hours < 48) return `${hours}h`;
        return `${days}d`;
    }

    function updateTimeSummaries() {
        const now = new Date();

        document.querySelectorAll('.time-summary').forEach((node) => {
            const start = new Date(node.dataset.start);
            const end = new Date(node.dataset.end);
            const startLabel = start.toLocaleString('en-US', dateOptions);
            const endLabel = end.toLocaleString('en-US', dateOptions);

            const untilStart = start - now;
            const untilEnd = end - now;

            // Compute status dynamically based on current time
            let status = 'ongoing';
            if (now < start) status = 'upcoming';
            if (now > end) status = 'ended';

            if (status === 'upcoming') {
                node.textContent = `Starts in ${formatCompactRelative(untilStart)}`;
                return;
            }

            if (status === 'ongoing') {
                node.textContent = `Started ${startLabel} • Ends in ${formatCompactRelative(untilEnd)}`;
                return;
            }

            node.textContent = `Ended ${formatCompactRelative(now - end)} ago`;
        });
    }
</script>

<style>
    .banner-section {
        margin: 1.5rem 0 2rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .section-title {
        letter-spacing: 0.08em;
        font-weight: 700;
        color: var(--muted);
        font-size: 0.9rem;
    }

    .banner-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .banner-card {
        border: 1px solid #222;
        border-radius: 14px;
        background: #111;
        padding: 1.25rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .banner-card + .banner-card {
        border-top: 1px solid #1a1a1a;
    }

    .card-top {
        display: flex;
        gap: 1rem;
        align-items: center;
        flex-wrap: wrap;
    }

    .title-block {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
        min-width: 0;
    }

    .title-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    h2 {
        margin: 0;
        font-size: 1.6rem;
        line-height: 1.2;
    }

    .status-pill {
        border-radius: 999px;
        padding: 0.25rem 0.7rem;
        font-size: 0.8rem;
        letter-spacing: 0.04em;
        color: var(--text);
        background: #1b1b1b;
        border: none;
    }

    .status-ongoing .status-pill {
        background: linear-gradient(120deg, #193422, #122413);
        color: #c8ffd6;
    }

    .status-ended .status-pill {
        background: #1a1a1a;
        color: var(--muted);
    }

    .status-upcoming .status-pill {
        background: linear-gradient(120deg, #1f2c44, #16243a);
        color: #d6e6ff;
    }

    .time-strip {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        margin: 0;
        color: var(--muted);
    }

    .banner-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 0.75rem 1.25rem;
    }

    .grid-item {
        border-top: 1px solid #1c1c1c;
        padding-top: 0.65rem;
        display: flex;
        flex-direction: column;
        gap: 0.15rem;
    }

    .meta-label {
        margin: 0;
        font-size: 0.9rem;
        color: var(--muted);
        letter-spacing: 0.02em;
    }

    .meta-value {
        margin: 0;
        font-size: 1.05rem;
        line-height: 1.5;
    }

    .rateup-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
    }

    .mini-card {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 1.5rem;
        height: 1.5rem;
        border-radius: 7px;
        padding: 2px;
        background: #0f0f0f;
        box-sizing: border-box;
        border: 1px solid #1c1c1c;
    }

    .mini-card .mini-icon {
        width: 100%;
        height: 100%;
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        filter: drop-shadow(0 0 0 transparent);
    }

    /* Reused Trekker rarity visuals (From Card.astro) */
    .mini-5 {
        background: linear-gradient(135deg, #d8e, #7ff);
    }

    .mini-4 {
        background: linear-gradient(135deg, #fd5, #efc);
    }

    .mini-3 {
        background: linear-gradient(135deg, #8ce, #dff);
    }

    a {
        color: var(--text);
    }

    a:hover {
        color: var(--accent);
    }

    @media (max-width: 720px) {
        .banner-grid {
            grid-template-columns: 1fr;
        }

        .card-top {
            flex-direction: column;
            align-items: flex-start;
        }
    }
</style>
